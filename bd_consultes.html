

<!DOCTYPE html>
<html class="writer-html5" lang="ca" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>El Zoo persistent &mdash; Introducció a la programació amb Java 2020-21 documentació</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/moistyle.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="author" title="Quant a aquests documents" href="about.html" />
    <link rel="index" title="Índex" href="genindex.html" />
    <link rel="search" title="Cerca" href="search.html" />
    <link rel="next" title="Exercicis de persistència" href="bd_exercicis.html" />
    <link rel="prev" title="JDBC" href="bd_jdbc.html" />
     
    <script class="googleanalytics" src="_static/moiscripts.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Introducció a la programació amb Java
          

          
            
            <img src="_static/logoprg.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2020-21
              </div>
            
          

          

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="primeres_passes.html">Primeres passes</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Elements bàsics de la programació</a></li>
<li class="toctree-l1"><a class="reference internal" href="moduls.html">Mòduls</a></li>
<li class="toctree-l1"><a class="reference internal" href="fitxers.html">Fitxers</a></li>
<li class="toctree-l1"><a class="reference internal" href="poo.html">Programació Orientada a Objectes</a></li>
<li class="toctree-l1"><a class="reference internal" href="biblioteques.html">Biblioteques</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="bd.html">Persistència amb bases de dades</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bd_modelrelacional_i_poo.html">POO i Model Relacional</a></li>
<li class="toctree-l2"><a class="reference internal" href="bd_sgbd.html">SGBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="bd_jdbc.html">JDBC</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">El Zoo persistent</a></li>
<li class="toctree-l2"><a class="reference internal" href="bd_exercicis.html">Exercicis de persistència</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="apendix.html">Apèndix</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Introducció a la programació amb Java</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="bd.html">Persistència amb bases de dades</a> &raquo;</li>
        
      <li>El Zoo persistent</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
    
           <div itemprop="articleBody">
            
  <div class="section" id="el-zoo-persistent">
<h1>El Zoo persistent<a class="headerlink" href="#el-zoo-persistent" title="Link permanent a aquest títol">¶</a></h1>
<p>A continuació veurem un exemple de com fer les operacions més habituals
amb bases de dades. En concret veurem com podem crear i eliminar taules, i
consultar, afegir, modificar i eliminar-hi registres.</p>
<p>El context escollit és un <em>zoo</em> on hi haurà <em>animals categoritzats</em>.</p>
<div class="section" id="el-model-de-dades">
<h2>El model de dades<a class="headerlink" href="#el-model-de-dades" title="Link permanent a aquest títol">¶</a></h2>
<p>Aquest és model de dades que farem servir:</p>
<div class="figure align-center" id="id1">
<p class="plantuml">
<img src="_images/plantuml-246ad8224e466496db9e7cca639c5308dbbd25f7.png" alt="&#64;startuml
    class Animal {
        - id: int
        - nom: String
        - categoria: Categoria
    }

    class Categoria {
        - id: int
        - nom: String
    }

    class Zoo

    Animal *-up- Categoria
    Zoo -right-&gt; Categoria
    Zoo -right-&gt; Animal
    Zoo -up-&gt; java.sql.Connection
    Zoo -up-&gt; java.sql.ResultSet
    Zoo -up-&gt; java.sql.Statement

    hide circle
    hide empty members
    skinparam classAttributeIconSize 0
    skinparam class {
        BackgroundColor White
        BorderColor Black
        ArrowColor Black
    }
&#64;enduml"/>
</p>
<p class="caption"><span class="caption-text">Diagrama de classes</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>En aquest model de dades distingim els següents elements:</p>
<ul>
<li><p>la classe <code class="docutils literal notranslate"><span class="pre">Animal</span></code></p>
<p>És tracta de la classe que defineix els objectes que manipularem a la
nostra demostració.</p>
<p>Disposa de dos camps: el <code class="docutils literal notranslate"><span class="pre">nom</span></code> i la <code class="docutils literal notranslate"><span class="pre">categoria</span></code></p>
<p>A banda, inclou un identificador de base de dades. Serà un valor que
generarà el nostre <em>SGBD</em> i que ens permetrà vincular les instàncies
de <code class="docutils literal notranslate"><span class="pre">Animal</span></code> amb la taula corresponent.</p>
</li>
<li><p>la classe <code class="docutils literal notranslate"><span class="pre">Categoria</span></code></p>
<p>Una classe molt bàsica que ens permetrà veure el concepte de <em>clau
forana</em> (<em>foreign key</em>)</p>
<p>A banda de guardar l’identificador a la base de dades, només disposa
d’un nom.</p>
</li>
<li><p>la classe <code class="docutils literal notranslate"><span class="pre">Zoo</span></code></p>
<p>Una classe <em>contenidor</em> que simplement realitzarà accessos a la base de
dades.</p>
</li>
</ul>
<p>A banda, disposarem de la classe <code class="docutils literal notranslate"><span class="pre">UsaZoo</span></code> que ens permetrà provar tot el
conjunt.</p>
</div>
<div class="section" id="connexio-i-desconnexio">
<h2>Connexió i desconnexió<a class="headerlink" href="#connexio-i-desconnexio" title="Link permanent a aquest títol">¶</a></h2>
<p>Comencem amb una implementació parcial de la classe <code class="docutils literal notranslate"><span class="pre">Zoo</span></code>, de manera que
ens permeti connectar-nos a la base de dades, i desconnectar-nos
posteriorment.</p>
<p>La classe <code class="docutils literal notranslate"><span class="pre">Zoo</span></code>, en aquesta primera versió, tindria el següent aspecte:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Zoo</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NOM_BASE_DE_DADES</span> <span class="o">=</span> <span class="s">&quot;animals.bd&quot;</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CADENA_DE_CONNEXIO</span> <span class="o">=</span> <span class="s">&quot;jdbc:sqlite:&quot;</span> <span class="o">+</span>
                                                     <span class="n">NOM_BASE_DE_DADES</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connecta</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>   <span class="c1">// ja connectat</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">CADENA_DE_CONNEXIO</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">desconnecta</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// ja desconnectat</span>
        <span class="n">conn</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Com podem veure, només disposem dels mètodes de connexió i desconnexió.
Abans de connectar, se n’assegura que no hi hagi ja una connexió. Abans de
desconnectar, comprova que hi hagi connexió.</p>
<p>No es gestiona cap excepció. Si apareixen, les haurà de gestionar el codi
que faci servir aquests mètodes.</p>
<p>Els dos mètodes poden generar l’excepció <code class="docutils literal notranslate"><span class="pre">SQLException</span></code> que és de tipus
gestionat i, per tant, ens caldrà tractar-la. Per simplicitat, els nostres
mètodes la deixaran passar anunciant-la amb <code class="docutils literal notranslate"><span class="pre">throws</span></code>.</p>
<p>Un possible codi usuari seria:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsaZoo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span> <span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="n">Zoo</span> <span class="n">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Zoo</span><span class="p">();</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&quot;Primer connectem amb la base de dades: &quot;</span><span class="p">);</span>
        <span class="n">zoo</span><span class="p">.</span><span class="na">connecta</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;connectat&quot;</span><span class="p">);</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&quot;Finalment tanquem la connexió amb la base de dades: &quot;</span><span class="p">);</span>
        <span class="n">zoo</span><span class="p">.</span><span class="na">desconnecta</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;desconnectat&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Fixa’t que <code class="docutils literal notranslate"><span class="pre">main()</span></code> tampoc no gestiona l’excepció <code class="docutils literal notranslate"><span class="pre">SQLException</span></code>.
Recorda que aquest és un programa d’exemple. En condicions normals sí
hauríem de fer alguna cosa més que simplement acceptar que es trenqui
l’execució.</p>
<p>En llençar l’execució, ens trobem:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> java UsaZoo
<span class="go">Primer connectem amb la base de dades: connectat</span>
<span class="go">Finalment tanquem la connexió amb la base de dades: desconnectat</span>
<span class="gp">$</span> du animals.bd
<span class="go">0   animals.bd</span>
</pre></div>
</div>
<p>És a dir, la connexió i desconnexió han funcionat i ens ha creat un fitxer
amb la base de dades, de moment buit.</p>
</div>
<div class="section" id="la-classe-categoria">
<h2>La classe <code class="docutils literal notranslate"><span class="pre">Categoria</span></code><a class="headerlink" href="#la-classe-categoria" title="Link permanent a aquest títol">¶</a></h2>
<p>Comencem amb la implementació de les categories.</p>
<p>La implementació de la classe <code class="docutils literal notranslate"><span class="pre">Categoria</span></code> que farem servir serà la
següent:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Categoria</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">// -1 indica no assignat/indefinit</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nom</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Categoria</span><span class="p">(</span><span class="n">String</span> <span class="n">nom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nom</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">nom</span><span class="p">.</span><span class="na">isBlank</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;El nom no pot ser null ni blanc&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="na">nom</span> <span class="o">=</span> <span class="n">nom</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">Categoria</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span> <span class="n">nom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">(</span><span class="n">nom</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;L&#39;identificador ha de ser positiu&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">idIndefinit</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idIndefinit</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="p">(</span><span class="s">&quot;L&#39;identificador no està disponible&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNom</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">nom</span><span class="p">;</span> <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Categoria(id:&quot;</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;indefinit&quot;</span> <span class="p">:</span> <span class="n">id</span><span class="p">)</span> <span class="o">+</span>
            <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">nom</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Aquesta classe ofereix dues maneres de construir instàncies: amb o sense
identificador. Quan la instància és creada al nostre programa, no disposem
d’identificador de la base de dades, clar, encara no hi ha estat inserida!
En canvi, quan creem la instància a partir de les dades d’un registre de
la base de dades, sí que sabem el seu <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
<p>El mètode <code class="docutils literal notranslate"><span class="pre">toString()</span></code> mostrarà com a indefinit l’identificador de les
instàncies que no en disposin.</p>
<p>El mètode <code class="docutils literal notranslate"><span class="pre">idIndefinit()</span></code> ens permet saber si l’identificador ha estat o
no definit en crear la categoria. En fer-ho d’aquesta manera, ens permetrà
que els usuaris de <code class="docutils literal notranslate"><span class="pre">Categoria</span></code> no hagin de saber que internament fem
servir el -1 per indicar que està indefinit l’identificador.</p>
<p>El mètode <code class="docutils literal notranslate"><span class="pre">getId()</span></code> ens permet obtenir l’identificador de la base de
dades sempre i quant aquest estigui definit. Altrament llençarà una
excepció.</p>
</div>
<div class="section" id="la-taula-categories">
<h2>La taula <em>CATEGORIES</em><a class="headerlink" href="#la-taula-categories" title="Link permanent a aquest títol">¶</a></h2>
<p>La taula en la que emmagatzemarem la informació de les instàncies de
<code class="docutils literal notranslate"><span class="pre">Categoria</span></code> es dirà <code class="docutils literal notranslate"><span class="pre">CATEGORIES</span></code> i tindrà la següent definició:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">CATEGORIES</span> <span class="p">(</span>
    <span class="n">id</span>   <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
    <span class="n">nom</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>A mencionar que l’identificador serà calculat pel SGBD gràcies a
<em>AUTOINCREMENT</em>.</p>
</div>
<div class="section" id="codi-de-creacio-de-la-taula">
<h2>Codi de creació de la taula<a class="headerlink" href="#codi-de-creacio-de-la-taula" title="Link permanent a aquest títol">¶</a></h2>
<p>Tot i que podríem crear aquesta taula directament al SGBD, ho farem a
partir d’un programa en Java.</p>
<p>El codi que afegim a la classe <code class="docutils literal notranslate"><span class="pre">Zoo</span></code> per crear la taula és el següent:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">creaTaulaCategories</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;CREATE TABLE  CATEGORIES (&quot;</span> <span class="o">+</span>
                 <span class="s">&quot;       id        INTEGER PRIMARY KEY AUTOINCREMENT,&quot;</span> <span class="o">+</span>
                 <span class="s">&quot;       nom       VARCHAR(40))&quot;</span><span class="p">;</span>
    <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span>
        <span class="n">st</span><span class="p">.</span><span class="na">executeUpdate</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">st</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>El més important d’aquest codi és que li demanem a la instància de la
connexió a la base de dades <code class="docutils literal notranslate"><span class="pre">conn</span></code> un <code class="docutils literal notranslate"><span class="pre">Statement</span></code>. Es tracta d’un
objecte que ens permetrà enviar-li al SGBD les comandes SQL.</p>
<p>En aquest cas, el que volem és que executi la comanda de modificació que
tenim a la variable <code class="docutils literal notranslate"><span class="pre">sql</span></code>. Per fer-ho, li ho demanem a <code class="docutils literal notranslate"><span class="pre">st</span></code> fent
servir el mètode <code class="docutils literal notranslate"><span class="pre">executeUpdate()</span></code>.</p>
<p>Tant l’obtenció del <code class="docutils literal notranslate"><span class="pre">Statement</span></code> com el seu ús poden generar
<code class="docutils literal notranslate"><span class="pre">SQLException</span></code> i, per tant, el nostre mètode ha de gestionar-la.</p>
<p>Cridarem aquesta funció des de <code class="docutils literal notranslate"><span class="pre">UsaZoo</span></code>:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="p">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsaZoo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span> <span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="n">Zoo</span> <span class="n">zoo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Zoo</span><span class="p">();</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&quot;Primer connectem amb la base de dades: &quot;</span><span class="p">);</span>
        <span class="n">zoo</span><span class="p">.</span><span class="na">connecta</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;connectat&quot;</span><span class="p">);</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Creem la taula CATEGORIES&quot;</span><span class="p">);</span>
        <span class="n">zoo</span><span class="p">.</span><span class="na">creaTaulaCategories</span><span class="p">();</span>

        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&quot;Finalment tanquem la connexió amb la base de dades: &quot;</span><span class="p">);</span>
        <span class="n">zoo</span><span class="p">.</span><span class="na">desconnecta</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;desconnectat&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>La sortida de <code class="docutils literal notranslate"><span class="pre">UsaZoo</span></code> serà:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> java UsaZoo
<span class="hll"><span class="go">Primer connectem amb la base de dades: connectat</span>
</span><span class="hll"><span class="go">Creem la taula CATEGORIES</span>
</span><span class="hll"><span class="go">Finalment tanquem la connexió amb la base de dades: desconnectat</span>
</span></pre></div>
</div>
<p>És a dir, teòricament ens ha creat la taula <em>CATEGORIES</em>. Comprovem-lo
amb:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sqlite3 animals.bd <span class="s2">&quot;.schema CATEGORIES&quot;</span>
<span class="hll"><span class="go">CREATE TABLE CATEGORIES (       id        INTEGER PRIMARY KEY AUTOINCREMENT,       nom       VARCHAR(40));</span>
</span><span class="gp">$</span> du -h animals.bd
<span class="hll"><span class="go">12K animals.bd</span>
</span></pre></div>
</div>
<p>Malgrat ens està ocupant 12K per una taula buida, podem concloure que sí
ens l’ha creada.</p>
</div>
<div class="section" id="eliminacio-de-la-taula">
<h2>Eliminació de la taula<a class="headerlink" href="#eliminacio-de-la-taula" title="Link permanent a aquest títol">¶</a></h2>
<p>Què passaria si tornéssim a executar <code class="docutils literal notranslate"><span class="pre">UsaZoo</span></code>?</p>
<p>Provem-ho!</p>
<div class="highlight-console notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> java UsaZoo
<span class="hll"><span class="go">Primer connectem amb la base de dades: connectat</span>
</span><span class="hll"><span class="go">Creem la taula CATEGORIES</span>
</span><span class="hll"><span class="go">Exception in thread &quot;main&quot; org.sqlite.SQLiteException: [SQLITE_ERROR] SQL error or missing database (table CATEGORIES already exists)</span>
</span><span class="hll"><span class="go">    at org.sqlite.core.DB.newSQLException(DB.java:1012)</span>
</span><span class="hll"><span class="go">    at org.sqlite.core.DB.newSQLException(DB.java:1024)</span>
</span><span class="hll"><span class="go">    at org.sqlite.core.DB.throwex(DB.java:989)</span>
</span><span class="hll"><span class="go">    at org.sqlite.core.NativeDB._exec_utf8(Native Method)</span>
</span><span class="hll"><span class="go">    at org.sqlite.core.NativeDB._exec(NativeDB.java:94)</span>
</span><span class="hll"><span class="go">    at org.sqlite.jdbc3.JDBC3Statement.executeUpdate(JDBC3Statement.java:102)</span>
</span><span class="hll"><span class="go">    at Zoo.creaTaulaCategories(Zoo.java:28)</span>
</span><span class="hll"><span class="go">    at UsaZoo.main(UsaZoo.java:11)</span>
</span></pre></div>
</td></tr></table></div>
<p>Ops! Què ha passat? Si tot anava tant bé?</p>
<p>El missatge és prou explícit: <em>la taula CATEGORIES ja existeix</em></p>
<p>És clar, estem intentant crear una taula que ja existeix. Tenim diferents
opcions per resoldre aquest problema.</p>
<p>L’opció més radical probablement és simplement eliminar el fitxer
<code class="docutils literal notranslate"><span class="pre">animals.bd</span></code>! Explorem d’altres opcions, eh?</p>
<p>Una de les opcions seria eliminar la taula abans de
crear-la. La sentència SQL seria <code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">TABLE</span> <span class="pre">CATEGORIES</span></code>. Aquesta
sentència l’executaríem amb el mateix mètode que fem servir per crear la
taula: <code class="docutils literal notranslate"><span class="pre">Statement.executeUpdate()</span></code></p>
<p>El problema és que si executem aquesta comanda quan encara no hi és la
taula, també ens <em>petarà</em> l’execució.</p>
<p>Per evitar-ho, afegirem el condicional <code class="docutils literal notranslate"><span class="pre">IF</span> <span class="pre">EXISTS</span></code> a la sentència SQL,
amb el que quedarà:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">CATEGORIES</span><span class="p">;</span>
</pre></div>
</div>
<p>Una altra opció seria transformar la sentència SQL de
<code class="docutils literal notranslate"><span class="pre">creaTaulaCategories()</span></code> per <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">IF</span> <span class="pre">NOT</span> <span class="pre">EXISTS</span> <span class="pre">CATEGORIES…</span></code>.
De fet, seria el més normal doncs no voldrem crear una taula nova cada
cop!</p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_02_drop.html"><span class="doc"> Exercici 06_02. Elimina taula CATEGORIES</span></a></p>
</div>
<div class="section" id="afegir-una-categoria">
<h2>Afegir una categoria<a class="headerlink" href="#afegir-una-categoria" title="Link permanent a aquest títol">¶</a></h2>
<p>Ara que ja tenim la taula <em>CATEGORIES</em>, hi podem afegir categories.</p>
<p>La sentència SQL seria quelcom similar a:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">CATEGORIES</span> <span class="p">(</span><span class="n">nom</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ocell&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Aquí <code class="docutils literal notranslate"><span class="pre">'ocell'</span></code> és el nom de la categoria que volem crear. El seu
identificador ens el crearà SQLite.</p>
<p>Una primera aproximació del mètode que ens inserirà una categoria en la
base de dades podria ser:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">afegeixCategoria</span><span class="p">(</span><span class="n">Categoria</span> <span class="n">categoria</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span>
            <span class="s">&quot;INSERT INTO CATEGORIES (nom) VALUES (&#39;%s&#39;)&quot;</span><span class="p">,</span>
            <span class="n">categoria</span><span class="p">.</span><span class="na">getNom</span><span class="p">());</span>
    <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span>
        <span class="n">st</span><span class="p">.</span><span class="na">executeUpdate</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">st</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Malgrat la seva senzillesa, aquest mètode és realment important doncs és
el responsable de convertir instàncies a registres a la base de dades.</p>
<p>Per cridar-lo, només ens cal disposar d’una instància de <code class="docutils literal notranslate"><span class="pre">Categoria</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Categoria</span> <span class="n">ocell</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Categoria</span><span class="p">(</span><span class="s">&quot;ocell&quot;</span><span class="p">);</span>
<span class="n">zoo</span><span class="p">.</span><span class="na">afegeixCategoria</span><span class="p">(</span><span class="n">ocell</span><span class="p">);</span>
</pre></div>
</div>
<p>Un cop executat, la taula <em>CATEGORIES</em> disposarà d’un nou registre:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sqlite3 animals.bd <span class="s1">&#39;select * from categories&#39;</span>
<span class="hll"><span class="go">1|ocell</span>
</span></pre></div>
</div>
<p>Fa bona pinta, no trobes?</p>
<p>Fixa’t que el SGBD ens ha generat l’identificador <code class="docutils literal notranslate"><span class="pre">1</span></code> de manera
automàtica.</p>
</div>
<div class="section" id="recuperar-les-categories">
<h2>Recuperar les categories<a class="headerlink" href="#recuperar-les-categories" title="Link permanent a aquest títol">¶</a></h2>
<p>Un cop sabem com guardar instàncies a una base de dades, comença a ser
hora de que aprenguem a fer l’operació contraria, recuperar-les.</p>
<p>Com sabem, les bases de dades relacionals ens permeten consultar les dades
de les taules amb una sentència especial que solem anomenar <em>consulta</em>,
<em>query</em> o <em>select</em>.</p>
<p>Per exemple, podem obtenir totes les categories ordenades per nom amb la
<em>query</em>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">CATEGORIES</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">nom</span><span class="p">;</span>
</pre></div>
</div>
<p>Com es veurà això des de Java?</p>
<p>Implementem el mètode <code class="docutils literal notranslate"><span class="pre">Zoo.recuperaCategories()</span></code> que ens retorni la
llista de categories trobades a la taula <em>CATEGORIES</em>:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Categoria</span><span class="o">&gt;</span> <span class="nf">recuperaCategories</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM CATEGORIES ORDER BY nom&quot;</span><span class="p">;</span>
    <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span>
<span class="hll">        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
</span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Categoria</span><span class="o">&gt;</span> <span class="n">categories</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="hll">        <span class="k">while</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">next</span><span class="p">())</span> <span class="p">{</span>
</span><span class="hll">            <span class="kt">int</span> <span class="n">bdId</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">);</span>
</span><span class="hll">            <span class="n">String</span> <span class="n">nom</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;nom&quot;</span><span class="p">);</span>
</span>            <span class="n">Categoria</span> <span class="n">categoria</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Categoria</span><span class="p">(</span><span class="n">bdId</span><span class="p">,</span> <span class="n">nom</span><span class="p">);</span>
            <span class="n">categories</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">categoria</span><span class="p">);</span>
        <span class="p">}</span>
<span class="hll">        <span class="n">rs</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
</span>        <span class="k">return</span> <span class="n">categories</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">st</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>El codi presenta les següents particularitats:</p>
<ul>
<li><p>Fa servir la classe <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> que encapsula, com bé indica el seu nom,
el conjunt de resultats obtinguts a partir d’una consulta.</p></li>
<li><p>En comptes de <code class="docutils literal notranslate"><span class="pre">executeUpdate()</span></code> ara fem <code class="docutils literal notranslate"><span class="pre">executeQuery()</span></code>. És el
mètode específic de JDBC quan el que volem és executar una consulta. En
fer-ho, ens retornarà un <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code>.</p></li>
<li><p>Per poder mostrar els valors recuperats, hem d’anar recorrent els
diferents valors del <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> també es sol conèixer com a <em>cursor</em> donat que funciona com
un cursor o índex a una llista.</p>
<p>El primer cop que cridem al mètode <code class="docutils literal notranslate"><span class="pre">next()</span></code>, el cursor es col·loca al
primer resultat. A mida que anem fent crides a <code class="docutils literal notranslate"><span class="pre">next()</span></code> el cursor va
passant al següent resultat disponible fins arribar al darrer; moment en
que retornarà <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>El resultat que hi ha al cursor es pot accedir directament a partir de
la variable <code class="docutils literal notranslate"><span class="pre">rs</span></code>. Fixa’t com obté el primer camp que esperem que sigui
enter doncs és l’identificador, i el segon, de tipus String, doncs és el
nom.</p>
</li>
<li><p>Per cada resultat, el codi crea una nova instància de <code class="docutils literal notranslate"><span class="pre">Categoria</span></code> amb
els valors d’identificador i nom trobats, i l’afegeix a la llista de
categories trobades, que retornarem finalment si no hi ha cap problema.</p>
<p>Aquí és on es produeix la màgia de la conversió de registre de la base
de dades a instància!</p>
<p>Ara les categories són creades amb un identificador <em>real</em>, afegit pel
SGBD al camp d’autoincrement.</p>
</li>
<li><p>Fixa’t que finalment tanquem el <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code>.</p>
<p>És una bona pràctica tancar-lo quan ja no el necessitem. Pensa que el
resultat pot ser un nombre realment gran de registres i que, per
qüestions pràctiques, sovint el SGBD no ens els enviarà tots de cop.</p>
<p>Si ja sabem que no ens cal més, en tancar el <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> estem
dient-li al SGBD que no cal que continuï mantenint els recursos
associats a aquest.</p>
<p>En aquest exemple concret, però, no és tan important, doncs de seguida
tancarem el <code class="docutils literal notranslate"><span class="pre">Statement</span></code> amb el que quedaran tancats tots els <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code>
oberts.</p>
</li>
</ul>
<p>Per cert, ens caldrà afegir l’import de <code class="docutils literal notranslate"><span class="pre">java.sql.ResultSet</span></code>.</p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_03_select.html"><span class="doc"> Exercici 06_03. Consulta de categories</span></a></p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_04_id.html"><span class="doc"> Exercici 06_04. Recuperar l’identificador</span></a></p>
</div>
<div class="section" id="que-passa-amb-els-animals">
<h2>Què passa amb els animals?<a class="headerlink" href="#que-passa-amb-els-animals" title="Link permanent a aquest títol">¶</a></h2>
<p>Ara ja sabem consultar i afegir instàncies d’una classe bàsica en una base
de dades.</p>
<p>Què ens pot faltar? Doncs quan tenim relacions entre classes o/i taules,
ens toca treballar una mica més.</p>
<div class="figure align-center">
<p class="plantuml">
<img src="_images/plantuml-f4f837fcf3ed776e0f14d7ece4f61efe931186eb.png" alt="&#64;startuml
    class Animal {
        - id: int
        - nom: String
        - categoria: Categoria
    }

    class Categoria {
        - id: int
        - nom: String
    }

    class Zoo

    Animal *- Categoria
    Zoo --&gt; Categoria
    Zoo --&gt; Animal

    hide circle
    hide empty members
    skinparam classAttributeIconSize 0
    skinparam class {
        BackgroundColor White
        BorderColor Black
        ArrowColor Black
    }
&#64;enduml"/>
</p>
</div>
<p>La classe <code class="docutils literal notranslate"><span class="pre">Animal</span></code> està relacionada amb <code class="docutils literal notranslate"><span class="pre">Categoria</span></code> per composició:
animal <em>té</em> categoria.</p>
<p>La relació entre taules i classes no sempre és <em>una-a-una</em>.
És prou freqüent que una classe es tradueixi en més d’una taula i que una
taula contingui dades que pertanyen a més d’una classe. Tot i que el nostre
exemple dels animals si que tindrem una taula per classe i una classe per
taula, ens permetrà tenir una idea de com funciona gràcies a la relació
entre <code class="docutils literal notranslate"><span class="pre">Animal</span></code> i <code class="docutils literal notranslate"><span class="pre">Categoria</span></code> o, si vols, entre <em>ANIMALS</em> i
<em>CATEGORIES</em>.</p>
<p>Emmagatzemarem els valors que composen les instàncies de <code class="docutils literal notranslate"><span class="pre">Animal</span></code> a la
taula <em>ANIMALS</em> que podem definir de la següent manera:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">ANIMALS</span> <span class="p">(</span>
    <span class="n">id</span>        <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
    <span class="n">nom</span>       <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">categoria</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">categoria</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">CATEGORIES</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>No hi ha gaire misteri en aquesta definició de taula, oi? És molt similar
a <em>CATEGORIES</em> però com que els animals han de pertànyer a una categoria,
representarem la relació amb una clau forana a la taula <em>CATEGORIES</em>.</p>
<p>La <em>integritat referencial</em> ens permet garantir coses com que no podrem
afegir un animal d’una categoria inexistent, o que no podrem crear la
taula <em>ANIMALS</em> si no disposem abans de <em>CATEGORIES</em>.</p>
<p>Cal tenir present que <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> no inclou integritat referencial per
defecte. Això vol dir, per exemple, que podríem assignar una referència a
una categoria inexistent per un animal, o fins i tot crear la taula
<em>ANIMALS</em> sense que existís <em>CATEGORIES</em>.</p>
<p>Si bé les versions més actuals de <code class="docutils literal notranslate"><span class="pre">squlite</span></code> suporten la integritat
referencial, no ho fan per defecte ni el suport està del tot resolt amb
el controlador per Java.</p>
<p>Si vols, pots experimentar amb els exercicis tot connectant a la base de
fent servir la següent cadena de connexió:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CADENA_DE_CONNEXIO</span> <span class="o">=</span> <span class="s">&quot;jdbc:sqlite:&quot;</span> <span class="o">+</span>
                                                 <span class="n">NOM_BASE_DE_DADES</span> <span class="o">+</span>
                                                 <span class="s">&quot;?integrity_check&amp;foreign_key_check&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Tingues present, però, que en la versió actual algunes de les operacions
no t’avisaran si es produeix un error i fallaran silenciosament. És
possible que la situació es solucioni en futures versions. Tenint en
comptes que és programari lliure, potser t’animes a fer-ho tu!</p>
<p>Pels exercicis que farem en aquest curs, suposarem que <strong>sí</strong> hi ha
integritat referencial i interaccionarem amb la base de dades de la manera
<em>correcta</em>.</p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_05_animals.html"><span class="doc"> Exercici 06_05. Creació i destrucció de la taula ANIMALS</span></a></p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_06_insert.html"><span class="doc"> Exercici 06_06. Inserció d’animals</span></a></p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_07_select.html"><span class="doc"> Exercici 06_07. Recuperar animals</span></a></p>
</div>
<div class="section" id="modificar-registres">
<h2>Modificar registres<a class="headerlink" href="#modificar-registres" title="Link permanent a aquest títol">¶</a></h2>
<p>Ara ja sabem inserir i consultar registres en taules. Aquestes dues
operacions formen part del que s’anomena <em>CRUD</em> (<em>Create</em>, <em>Read</em>,
<em>Update</em> i <em>Delete</em>)</p>
<ul class="simple">
<li><p>“C”: hem creat registres a la base de dades</p></li>
<li><p>“R”: hem llegit (<em>read</em>) o també fet consultes a la base de dades</p></li>
</ul>
<p>En aquesta ocasió atacarem la “U” que correspon a <em>Update</em> o modificació
al nostre idioma.</p>
<p>Modificar una categoria és fàcil doncs no depen de cap altre taula.</p>
<p>La sentència SQL per modificar la categoria <em>peix</em> a <em>peixos</em> seria:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">CATEGORIES</span> <span class="k">SET</span> <span class="n">nom</span> <span class="o">=</span> <span class="s1">&#39;peixos&#39;</span> <span class="k">WHERE</span> <span class="n">nom</span> <span class="o">=</span> <span class="s1">&#39;peix&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Al nostre programa només hem d’executar-ho amb un <code class="docutils literal notranslate"><span class="pre">executeUpdate()</span></code> que
ens retornarà el nombre de registres que resulten modificats.</p>
<p>Un mètode que hagués de modificar el registre corresponent a una instància
de <code class="docutils literal notranslate"><span class="pre">Categoria</span></code> hauria de considerar els següents casos:</p>
<ul>
<li><p>cas que la categoria no estigui a la base de dades</p>
<p>Aquest cas seria un error doncs no es pot modificar una cosa que encara
no hi és. Es podria procedir de diferents maneres, com ara generant una
excepció o simplement ignorant i no fent res.</p>
<p>En molts casos, el que es persegueix és l’operació <em>modifica si existeix
i sinó insereix</em>. És a dir, si el registre hi és, el modifica i sinó
l’afegeix. Aquesta operació és tan comuna que fins i tot està recollida
com a <a class="reference external" href="https://www.sqlite.org/lang_UPSERT.html">upsert</a></p>
</li>
<li><p>cas que la categoria sí estigui a la base de dades, s’executa la
sentència <em>UPDATE</em> amb la condició <em>WHERE</em>  exigint que s’apliqui només
al registre que coincideixi amb l’identificador de la categoria.</p></li>
</ul>
<p>Per modificar un animal la situació és una mica més complexa doncs hem de
garantir també que la nova categoria hi sigui a la base de dades. En tot
cas, res molt més difícil del que ja hem sabut resoldre.</p>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_08_update.html"><span class="doc"> Exercici 06_08. Modificació d’animals</span></a></p>
</div>
<div class="section" id="eliminacio-de-registres">
<h2>Eliminació de registres<a class="headerlink" href="#eliminacio-de-registres" title="Link permanent a aquest títol">¶</a></h2>
<p>Així com afegir, consultar i modificar animals ens ha resultat més difícil
que fer-ho amb categories, la situació s’inverteix quan toca eliminar.</p>
<p>L’eliminació d’un animal és molt fàcil. En
tenim prou amb el seu <code class="docutils literal notranslate"><span class="pre">id</span></code> i executar la sentència SQL <code class="docutils literal notranslate"><span class="pre">DELETE</span> <span class="pre">FROM</span> <span class="pre">ANIMALS</span> <span class="pre">WHERE</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">5</span></code>.</p>
<p>Per descomptat, si l’animal no es troba a la base de dades haurem de
generar un error o bé ignorar el cas.</p>
<p>Eliminar una categoria és una mica més problemàtic. Normalment cal crear
<em>ANIMALS</em> tot indicant què ha de fer el SGBD quan s’elimina la clau
forana. Sovint això es fa amb <em>ON DELETE CASCADE</em>. Tenint en compte que
sqlite no ens ofereix gaire suport a la integritat referencial, ens tocarà
també implementar-ho si volem aquest comportament.</p>
<p>Una manera d’eliminar els animals <em>en cascada</em>, seria definir un mètode
que retorni la llista de tots els animals d’una categoria i anar-los
eliminant un a un.</p>
<p>Potser més fàcil encara seria executar dues sentències. Per exemple,
suposant que la categoria a eliminar té com a identificador el 5, ens
caldria executar les següents sentències:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">ANIMALS</span> <span class="k">WHERE</span> <span class="n">categoria</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">CATEGORIES</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</pre></div>
</div>
<p><img alt="exerciseicon__T" src="_images/exerciseicon__T.png" /> <a class="reference internal" href="exercici_06_09_delete.html"><span class="doc"> Exercici 06_09. Eliminació de categories i animals</span></a></p>
</div>
<div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Link permanent a aquest títol">¶</a></h2>
<p>Hem arribat al final d’aquest recorregut per la persistència des de la
POO. Has vist com hem salvat el salt entre els objectes i les taules d’una
manera molt explícita.</p>
<p>Hem treballat les operacions bàsiques anomenades sovint com <em>CRUD</em>:
creació, lectura, modificació i eliminació.</p>
<p>És molt probable que quan desenvolupis et trobis amb biblioteques que ja
et facin aquestes traduccions per tu. En tot cas, és important que
entenguis que el que fan no és màgia i que tu ho pots també programar, en
cas de necessitar-ho.</p>
</div>
</div>


           </div>
           
          </div>
    <div class="googleanalytics">
    <div id="cookiesbox">
        Aquest lloc web utilitza galetes (<i>cookies</i>) per a analitzar el seu ús
        amb les eines que ofereix <a href="https://www.google.com/analytics">Google Analytics</a>.
        En continuar navegant-hi, estàs acceptant-ho.
        <br/>
        <a class="btn btn-neutral" onclick="setUserAcceptsCookies();">
            Tancar
            <span class="fa fa-window-close"></span>
        </a>
    </div>
    <script>setCookiesboxVisibility();</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41103782-2', 'auto');
      ga('send', 'pageview');
    </script>
</div>


          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bd_exercicis.html" class="btn btn-neutral float-right" title="Exercicis de persistència" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bd_jdbc.html" class="btn btn-neutral float-left" title="JDBC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020-2021 Moisès Gómez Girón

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>